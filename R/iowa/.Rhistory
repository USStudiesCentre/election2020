"end_date" = "as_of_date", "party",
"election_year")) %>%
group_by(contest, last_name, end_date) %>%
fill(endorsement_points) %>%
ungroup() %>%
group_by(last_name) %>%
nest() %>%
mutate(data = map(~filter(sample_size != 0, .x) %>%
mutate(numerator = share * (1- share), .x) %>%
mutate(new_weight = sqrt(abs(numerator/sample_size)), .x) %>%
select(-numerator)), .x) %>%
unnest() %>%
ungroup()
tmp <- left_join(iowa_polls, candidate_endorsements,
by = c("contest", "last_name" = "endorsee",
"end_date" = "as_of_date", "party",
"election_year")) %>%
group_by(contest, last_name, end_date) %>%
fill(endorsement_points) %>%
ungroup() %>%
group_by(last_name) %>%
nest() %>%
mutate(data = map(., ~filter(sample_size != 0) %>%
mutate(numerator = share * (1- share)) %>%
mutate(new_weight = sqrt(abs(numerator/sample_size))) %>%
select(-numerator))) %>%
unnest() %>%
ungroup()
iowa_polls <- left_join(iowa_polls, candidate_endorsements,
by = c("contest", "last_name" = "endorsee",
"end_date" = "as_of_date", "party",
"election_year")) %>%
group_by(contest, last_name, end_date) %>%
fill(endorsement_points) %>%
ungroup() %>%
group_by(last_name) %>%
nest() %>%
mutate(data = map(data, ~filter(sample_size != 0) %>%
mutate(numerator = share * (1- share)) %>%
mutate(new_weight = sqrt(abs(numerator/sample_size))) %>%
select(-numerator))) %>%
unnest() %>%
ungroup()
iowa_polls <- left_join(iowa_polls, candidate_endorsements,
by = c("contest", "last_name" = "endorsee",
"end_date" = "as_of_date", "party",
"election_year")) %>%
group_by(contest, last_name, end_date) %>%
fill(endorsement_points) %>%
ungroup() %>%
group_by(last_name) %>%
nest() %>%
mutate(data = map(data, ~filter(sample_size != 0, .x) %>%
mutate(numerator = share * (1- share)) %>%
mutate(new_weight = sqrt(abs(numerator/sample_size))) %>%
select(-numerator))) %>%
unnest() %>%
ungroup()
iowa_polls <- left_join(iowa_polls, candidate_endorsements,
by = c("contest", "last_name" = "endorsee",
"end_date" = "as_of_date", "party",
"election_year")) %>%
group_by(contest, last_name, end_date) %>%
fill(endorsement_points) %>%
ungroup() %>%
group_by(last_name) %>%
nest() %>%
mutate(data = map(data, ~filter(sample_size != 0, .x)
)
)
dir_ls(here::here("data"))
polls <- read_excel(here::here("data/PrimaryPollsSince1980.xlsx"), sheet = 1) %>%
select(-`...6`) %>%
filter(state == "Iowa") %>%
separate(contest, c("election_year", "party"), sep = 4, remove = FALSE) %>%
mutate(st=state.abb[match(state,state.name)]) %>%
# grab mid date for poll
mutate(ex = interval(as_date(start_date),as_date(end_date)),
mid_date = int_start(ex) + ((int_end(ex)-int_start(ex))/2)) %>%
select(-ex) %>%
# weight observations
mutate(weight = sqrt(sample_size))
iowa_results <- read_excel(here::here("data/Presidential primary results, 1968-2016.xlsx"), sheet = 1)  %>%
filter(state == "Iowa") %>%
select(iowa_votes = votes,
iowa_pct = pct,
contest,
true_name,
iowa_date = date) %>%
# the set should be filtered for those who received >10% of vote
filter(iowa_pct >= 10) %>%
filter(!true_name %in% c("Uncommitted", "No preference", "Others")) %>%
# some candidates are repeated twice (different sources). They're all pretty similar, so I'll just select one but this should be sorted out properly sooner rather than later
distinct(contest, true_name, .keep_all = TRUE) %>%
# add 1992 candidates back in as Harkin appears to be an outlier in terms of support from Iowans (not surprising given that he was their rep)
bind_rows(., read_excel(here::here("data/Presidential primary results, 1968-2016.xlsx"), sheet = 1)  %>%
filter(state == "Iowa") %>%
select(iowa_votes = votes,
iowa_pct = pct,
contest,
true_name,
iowa_date = date) %>%
filter(contest == "1992D"))
iowa_polls <- polls %>%
drop_na(true_name) %>%
# subset candidates who received more than 10% of caucus support
inner_join(., iowa_results %>%
distinct(contest, true_name, iowa_date, iowa_pct)) %>%
filter(share>0) %>%
filter(as.Date(end_date) <= as.Date(iowa_date)) %>%
mutate(year_before = iowa_date - years(2)) %>%
# filter for year out to remove outliers on x axis
filter(as.Date(end_date) >= as.Date(year_before)) %>%
# remove 1992 candidates except for Harkin and Clinton
filter(!last_name %in% c("Kerrey", "Tsongas", "Brown")) %>%
mutate(year_party = paste0(cycle, ": ", candidateparty)) %>%
group_by(year_party) %>%
arrange(iowa_pct, .by_group = TRUE)  %>%
ungroup() %>%
mutate(year_party = factor(year_party))
candidate_endorsements <- read_excel(here::here("data/Endorsementpointsbyday.xlsx"), sheet = 1) %>%
separate(contest, c("election_year", "party"), sep = 4, remove = FALSE)
polls <- read_excel(here::here("data/PrimaryPollsSince1980.xlsx"), sheet = 1) %>%
select(-`...6`) %>%
filter(state == "Iowa") %>%
separate(contest, c("election_year", "party"), sep = 4, remove = FALSE) %>%
mutate(st=state.abb[match(state,state.name)]) %>%
# grab mid date for poll
mutate(ex = interval(as_date(start_date),as_date(end_date)),
mid_date = int_start(ex) + ((int_end(ex)-int_start(ex))/2)) %>%
select(-ex) %>%
# weight observations
mutate(weight = sqrt(sample_size))
iowa_results <- read_excel(here::here("data/Presidential primary results, 1968-2016.xlsx"), sheet = 1)  %>%
filter(state == "Iowa") %>%
select(iowa_votes = votes,
iowa_pct = pct,
contest,
true_name,
iowa_date = date) %>%
# the set should be filtered for those who received >10% of vote
filter(iowa_pct >= 10) %>%
filter(!true_name %in% c("Uncommitted", "No preference", "Others")) %>%
# some candidates are repeated twice (different sources). They're all pretty similar, so I'll just select one but this should be sorted out properly sooner rather than later
distinct(contest, true_name, .keep_all = TRUE) %>%
# add 1992 candidates back in as Harkin appears to be an outlier in terms of support from Iowans (not surprising given that he was their rep)
bind_rows(., read_excel(here::here("data/Presidential primary results, 1968-2016.xlsx"), sheet = 1)  %>%
filter(state == "Iowa") %>%
select(iowa_votes = votes,
iowa_pct = pct,
contest,
true_name,
iowa_date = date) %>%
filter(contest == "1992D"))
iowa_polls <- polls %>%
drop_na(true_name) %>%
# subset candidates who received more than 10% of caucus support
inner_join(., iowa_results %>%
distinct(contest, true_name, iowa_date, iowa_pct)) %>%
filter(share>0) %>%
filter(as.Date(end_date) <= as.Date(iowa_date)) %>%
mutate(year_before = iowa_date - years(2)) %>%
# filter for year out to remove outliers on x axis
filter(as.Date(end_date) >= as.Date(year_before)) %>%
# remove 1992 candidates except for Harkin and Clinton
filter(!last_name %in% c("Kerrey", "Tsongas", "Brown")) %>%
mutate(year_party = paste0(cycle, ": ", candidateparty)) %>%
group_by(year_party) %>%
arrange(iowa_pct, .by_group = TRUE)  %>%
ungroup() %>%
mutate(year_party = factor(year_party))
candidate_endorsements <- read_excel(here::here("data/Endorsementpointsbyday.xlsx"), sheet = 1) %>%
separate(contest, c("election_year", "party"), sep = 4, remove = FALSE)
iowa_polls <- left_join(iowa_polls, candidate_endorsements,
by = c("contest", "last_name" = "endorsee",
"end_date" = "as_of_date", "party",
"election_year")) %>%
group_by(contest, last_name, end_date) %>%
fill(endorsement_points) %>%
ungroup() %>%
filter(sample_size != 0) %>%
mutate(numerator = share * (1- share)) %>%
mutate(new_weight = sqrt(abs(numerator/sample_size))) %>%
select(-numerator) %>%
group_by(last_name) %>%
nest()
iowa_polls
iowa_polls <- left_join(iowa_polls, candidate_endorsements,
by = c("contest", "last_name" = "endorsee",
"end_date" = "as_of_date", "party",
"election_year")) %>%
group_by(contest, last_name, end_date) %>%
fill(endorsement_points) %>%
ungroup() %>%
filter(sample_size != 0) %>%
mutate(numerator = share * (1- share)) %>%
mutate(new_weight = sqrt(abs(numerator/sample_size))) %>%
select(-numerator) %>%
group_by(contest, last_name) %>%
nest()
iowa_polls <- polls %>%
drop_na(true_name) %>%
# subset candidates who received more than 10% of caucus support
inner_join(., iowa_results %>%
distinct(contest, true_name, iowa_date, iowa_pct)) %>%
filter(share>0) %>%
filter(as.Date(end_date) <= as.Date(iowa_date)) %>%
mutate(year_before = iowa_date - years(2)) %>%
# filter for year out to remove outliers on x axis
filter(as.Date(end_date) >= as.Date(year_before)) %>%
# remove 1992 candidates except for Harkin and Clinton
filter(!last_name %in% c("Kerrey", "Tsongas", "Brown")) %>%
mutate(year_party = paste0(cycle, ": ", candidateparty)) %>%
group_by(year_party) %>%
arrange(iowa_pct, .by_group = TRUE)  %>%
ungroup() %>%
mutate(year_party = factor(year_party))
candidate_endorsements <- read_excel(here::here("data/Endorsementpointsbyday.xlsx"), sheet = 1) %>%
separate(contest, c("election_year", "party"), sep = 4, remove = FALSE)
iowa_polls <- left_join(iowa_polls, candidate_endorsements,
by = c("contest", "last_name" = "endorsee",
"end_date" = "as_of_date", "party",
"election_year")) %>%
group_by(contest, last_name, end_date) %>%
fill(endorsement_points) %>%
ungroup() %>%
filter(sample_size != 0) %>%
mutate(numerator = share * (1- share)) %>%
mutate(new_weight = sqrt(abs(numerator/sample_size))) %>%
select(-numerator) %>%
group_by(contest, last_name) %>%
nest()
iowa_polls
hc_08_iowa_polls <- iowa_polls %>% filter(year == 2008 & last_name == "Clinton")
hc_08_iowa_polls <- iowa_polls %>% filter(year == "2008" & last_name == "Clinton")
hc_08_iowa_polls <- iowa_polls %>% filter(year = 2008 & last_name == "Clinton")
hc_08_iowa_polls <- iowa_polls %>%
filter(contest == "2008D" & last_name == "Clinton")
hc_08_iowa_polls
hc_08_iowa_polls <- iowa_polls %>%
filter(contest == "2008D" & last_name == "Clinton") %>%
select(data)
iowa_polls <- left_join(iowa_polls, candidate_endorsements,
by = c("contest", "last_name" = "endorsee",
"end_date" = "as_of_date", "party",
"election_year")) %>%
group_by(contest, last_name, end_date) %>%
fill(endorsement_points) %>%
ungroup() %>%
filter(sample_size != 0) %>%
mutate(numerator = share * (1- share)) %>%
mutate(new_weight = sqrt(abs(numerator/sample_size))) %>%
select(-numerator) %>%
group_by(contest, last_name) %>%
nest() %>%
ungroup()
iowa_polls <- polls %>%
drop_na(true_name) %>%
# subset candidates who received more than 10% of caucus support
inner_join(., iowa_results %>%
distinct(contest, true_name, iowa_date, iowa_pct)) %>%
filter(share>0) %>%
filter(as.Date(end_date) <= as.Date(iowa_date)) %>%
mutate(year_before = iowa_date - years(2)) %>%
# filter for year out to remove outliers on x axis
filter(as.Date(end_date) >= as.Date(year_before)) %>%
# remove 1992 candidates except for Harkin and Clinton
filter(!last_name %in% c("Kerrey", "Tsongas", "Brown")) %>%
mutate(year_party = paste0(cycle, ": ", candidateparty)) %>%
group_by(year_party) %>%
arrange(iowa_pct, .by_group = TRUE)  %>%
ungroup() %>%
mutate(year_party = factor(year_party))
candidate_endorsements <- read_excel(here::here("data/Endorsementpointsbyday.xlsx"), sheet = 1) %>%
separate(contest, c("election_year", "party"), sep = 4, remove = FALSE)
iowa_polls <- left_join(iowa_polls, candidate_endorsements,
by = c("contest", "last_name" = "endorsee",
"end_date" = "as_of_date", "party",
"election_year")) %>%
group_by(contest, last_name, end_date) %>%
fill(endorsement_points) %>%
ungroup() %>%
filter(sample_size != 0) %>%
mutate(numerator = share * (1- share)) %>%
mutate(new_weight = sqrt(abs(numerator/sample_size))) %>%
select(-numerator) %>%
group_by(contest, last_name) %>%
nest() %>%
ungroup()
hc_08_iowa_polls <- iowa_polls %>%
filter(contest == "2008D" & last_name == "Clinton") %>%
select(data)
hc_08_iowa_polls
hc_08_iowa_polls$data
hc_08_iowa_polls <- iowa_polls %>%
filter(contest == "2008D" & last_name == "Clinton") %>%
.[[data]]
iowa_polls <- left_join(iowa_polls, candidate_endorsements,
by = c("contest", "last_name" = "endorsee",
"end_date" = "as_of_date", "party",
"election_year")) %>%
group_by(contest, last_name, end_date) %>%
fill(endorsement_points) %>%
ungroup() %>%
filter(sample_size != 0) %>%
mutate(numerator = share * (1- share)) %>%
mutate(new_weight = sqrt(abs(numerator/sample_size))) %>%
select(-numerator) %>%
group_by(contest, last_name) %>%
nest() %>%
ungroup()
hc_08_iowa_polls <- iowa_polls %>%
filter(contest == "2008D" & last_name == "Clinton") %>%
.[[data]]
hc_08_iowa_polls$data[[1]]
iowa_polls %>%
filter(contest == "2008D" & last_name == "Clinton") %>%
select(data) %>%
.[[1]]
nls(iowa_pct ~ share + endorsement_points,
data = hc_08_iowa_polls, weights = new_weight,
start=list(share=10, endorsement_points=0))
hc_08_iowa_polls$iowa_pct
hc_08_iowa_polls <- iowa_polls %>%
filter(contest == "2008D" & last_name == "Clinton") %>%
select(data) %>%
.[[1]]
names(hc_08_iowa_polls)
polls <- read_excel(here::here("data/PrimaryPollsSince1980.xlsx"), sheet = 1) %>%
select(-`...6`) %>%
filter(state == "Iowa") %>%
separate(contest, c("election_year", "party"), sep = 4, remove = FALSE) %>%
mutate(st=state.abb[match(state,state.name)]) %>%
# grab mid date for poll
mutate(ex = interval(as_date(start_date),as_date(end_date)),
mid_date = int_start(ex) + ((int_end(ex)-int_start(ex))/2)) %>%
select(-ex) %>%
# weight observations
mutate(weight = sqrt(sample_size))
iowa_results <- read_excel(here::here("data/Presidential primary results, 1968-2016.xlsx"), sheet = 1)  %>%
filter(state == "Iowa") %>%
select(iowa_votes = votes,
iowa_pct = pct,
contest,
true_name,
iowa_date = date) %>%
# the set should be filtered for those who received >10% of vote
filter(iowa_pct >= 10) %>%
filter(!true_name %in% c("Uncommitted", "No preference", "Others")) %>%
# some candidates are repeated twice (different sources). They're all pretty similar, so I'll just select one but this should be sorted out properly sooner rather than later
distinct(contest, true_name, .keep_all = TRUE) %>%
# add 1992 candidates back in as Harkin appears to be an outlier in terms of support from Iowans (not surprising given that he was their rep)
bind_rows(., read_excel(here::here("data/Presidential primary results, 1968-2016.xlsx"), sheet = 1)  %>%
filter(state == "Iowa") %>%
select(iowa_votes = votes,
iowa_pct = pct,
contest,
true_name,
iowa_date = date) %>%
filter(contest == "1992D"))
iowa_polls <- polls %>%
drop_na(true_name) %>%
# subset candidates who received more than 10% of caucus support
inner_join(., iowa_results %>%
distinct(contest, true_name, iowa_date, iowa_pct)) %>%
filter(share>0) %>%
filter(as.Date(end_date) <= as.Date(iowa_date)) %>%
mutate(year_before = iowa_date - years(2)) %>%
# filter for year out to remove outliers on x axis
filter(as.Date(end_date) >= as.Date(year_before)) %>%
# remove 1992 candidates except for Harkin and Clinton
filter(!last_name %in% c("Kerrey", "Tsongas", "Brown")) %>%
mutate(year_party = paste0(cycle, ": ", candidateparty)) %>%
group_by(year_party) %>%
arrange(iowa_pct, .by_group = TRUE)  %>%
ungroup() %>%
mutate(year_party = factor(year_party))
candidate_endorsements <- read_excel(here::here("data/Endorsementpointsbyday.xlsx"), sheet = 1) %>%
separate(contest, c("election_year", "party"), sep = 4, remove = FALSE)
iowa_polls <- left_join(iowa_polls, candidate_endorsements,
by = c("contest", "last_name" = "endorsee",
"end_date" = "as_of_date", "party",
"election_year")) %>%
group_by(contest, last_name, end_date) %>%
fill(endorsement_points) %>%
ungroup() %>%
filter(sample_size != 0) %>%
mutate(numerator = share * (1- share)) %>%
mutate(new_weight = sqrt(abs(numerator/sample_size))) %>%
select(-numerator) %>%
group_by(contest, last_name) %>%
nest() %>%
ungroup()
# Subset to one curve for now
hc_08_iowa_polls <- iowa_polls %>%
filter(contest == "2008D" & last_name == "Clinton") %>%
select(data) %>%
.[[1]]
hc_08_iowa_polls
hc_08_iowa_polls[1]
# Subset to one curve for now
hc_08_iowa_polls <- iowa_polls %>%
filter(contest == "2008D" & last_name == "Clinton") %>%
unnest()
# Subset to one curve for now
hc_08_iowa_polls <- iowa_polls %>%
filter(contest == "2008D" & last_name == "Clinton") %>%
unnest(cols = c(data))
hc_08_iowa_polls
hc_08_iowa_polls$iowa_pct
nls(iowa_pct ~ share + endorsement_points,
data = hc_08_iowa_polls, weights = new_weight,
start=list(share=10, endorsement_points=0,iowa_pct = 30))
library(brms)
install.packages("brms")
nls(iowa_pct ~ share, data = hc_08_iowa_polls, start = c(share = 10, iowa_pct = 30))
lm(iowa_pct ~ share, data = hc_08_iowa_polls)
names(hc_08_iowa_polls)
lm(iowa_pct ~ share + endorsement_points, data = hc_08_iowa_polls)
summary(lm(iowa_pct ~ share + endorsement_points, data = hc_08_iowa_polls))
nls(iowa_pct ~ bs(share), data = hc_08_iowa_polls, start = c(share = 10, iowa_pct = 30))
nls(iowa_pct ~ bs(share), data = hc_08_iowa_polls)
nls(iowa_pct ~ splines::bs(share), data = hc_08_iowa_polls)
nls(iowa_pct ~ splines::bs(share), data = hc_08_iowa_polls)
lm_model <- lm(iowa_pct ~ share + endorsement_points, data = hc_08_iowa_polls))
lm_model <- lm(iowa_pct ~ share + endorsement_points, data = hc_08_iowa_polls)
exp(coef(lm_model)[1])
share_start <- exp(coef(lm_model)[1])
endorsement_points_start <- exp(coef(lm_model)[2])
nls(iowa_pct ~ splines::bs(share) + endorsement_points, data = hc_08_iowa_polls, start = c(share = share_start,
endorsement_points = endorsement_points_start))
nls(iowa_pct ~ share + endorsement_points, data = hc_08_iowa_polls, start = c(share = share_start,
endorsement_points = endorsement_points_start))
lm_model <- lm(log(iowa_pct) ~ log(share) + log(endorsement_points) data = hc_08_iowa_polls)
lm_model <- lm(log(iowa_pct) ~ log(share) + log(endorsement_points), data = hc_08_iowa_polls)
share_start <- exp(coef(lm_model)[1])
endorsement_points_start <- exp(coef(lm_model)[2])
nls(iowa_pct ~ share + endorsement_points,
data = hc_08_iowa_polls,
start = c(share = share_start,
endorsement_points = endorsement_points_start))
nls(iowa_pct ~ share + endorsement_points,
data = hc_08_iowa_polls,
start = c(share = share_start,
endorsement_points = endorsement_points_start),
weights = new_weight)
lm_model <- lm(log(iowa_pct) ~ share + endorsement_points, data = hc_08_iowa_polls)
share_start <- exp(coef(lm_model)[1])
endorsement_points_start <- exp(coef(lm_model)[2])
nls(iowa_pct ~ share + endorsement_points,
data = hc_08_iowa_polls,
start = c(share = share_start,
endorsement_points = endorsement_points_start),
weights = new_weight)
nls(iowa_pct ~ f(share) + endorsement_points,
data = hc_08_iowa_polls,
start = c(share = share_start,
endorsement_points = endorsement_points_start),
weights = new_weight)
nls(iowa_pct ~ share + endorsement_points,
data = hc_08_iowa_polls,
start = c(share = share_start,
endorsement_points = endorsement_points_start),
weights = new_weight)
# grab starting values
lm_model <- lm(log(iowa_pct) ~ log(share) + log(endorsement_points), data = hc_08_iowa_polls)
summary(lm_model)
gam(iowa_pct ~ s(share) + s(endorsement_points), data = hc_08_iowa_polls,
weights = new_weight)
glm(iowa_pct ~ s(share) + s(endorsement_points), data = hc_08_iowa_polls,
weights = new_weight)
mgcv::gam(iowa_pct ~ mgcv::s(share) + mgcv::s(endorsement_points), data = hc_08_iowa_polls,
weights = new_weight)
share_start <- exp(coef(lm_model)[1])
endorsement_points_start <- exp(coef(lm_model)[2])
nls(iowa_pct ~ s(share) + endorsement_points,
data = hc_08_iowa_polls,
start = c(share = share_start,
endorsement_points = endorsement_points_start),
weights = new_weight)
nls(iowa_pct ~ share + endorsement_points,
data = hc_08_iowa_polls,
start = c(share = share_start,
endorsement_points = endorsement_points_start),
weights = new_weight)
install.packages(minpack.lm)
install.packages("minpack.lm")
minpack.lm::nlsLM(iowa_pct ~ share + endorsement_points,
data = hc_08_iowa_polls,
start = list(a=1,b=1))
# grab starting values
lm_model <- lm(log(iowa_pct) ~ log(share) + log(endorsement_points), data = hc_08_iowa_polls)
share_start <- exp(coef(lm_model)[1])
endorsement_points_start <- exp(coef(lm_model)[2])
nls(iowa_pct ~ share + endorsement_points,
data = hc_08_iowa_polls,
start = c(share = share_start,
endorsement_points = endorsement_points_start),
weights = new_weight)
minpack.lm::nlsLM(iowa_pct ~ share + endorsement_points,
data = hc_08_iowa_polls,
start = list(share=1,endorsement_points=1))
minpack.lm::nlsLM(iowa_pct ~ share + endorsement_points,
data = hc_08_iowa_polls,
start = list(share=1,endorsement_points=1, iowa_pct =1))
nlm(iowa_pct ~ share + endorsement_points,
data = hc_08_iowa_polls,
start = c(share = share_start,
endorsement_points = endorsement_points_start),
weights = new_weight)
install.packages('gnm')
source('~/Dropbox (Sydney Uni)/primaries/R/iowa/eda_iowa.R', echo=TRUE)
